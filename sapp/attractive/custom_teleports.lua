--[[
=====================================================================================
SCRIPT NAME:      custom_teleports.lua
DESCRIPTION:      Creates configurable instant teleport zones that transport players
                  between defined locations when entering activation areas.

FEATURES:
                  - Map-specific teleport configuration
                  - Adjustable activation radius
                  - Optional crouch activation requirement
                  - Cooldown system to prevent abuse
                  - Vehicle usage protection

USAGE:
                  1. Add teleport entries for each supported map in CFG table
                  2. Format: {srcX, srcY, srcZ, radius, destX, destY, destZ, zOffset}
                  3. Set CROUCH_ACTIVATED true for crouch-only activation

EXAMPLE CONFIG:
                  ["bloodgulch"] = {
                      {98.80, -156.30, 1.70, 0.5, 72.58, -126.33, 1.18, 0}, -- Red base health pack to rocket launcher mid-map
                      {36.87, -82.33, 1.70, 0.5, 72.58, -126.33, 1.18, 0}    -- Blue base health pack to rocket launcher mid-map
                  }

LAST UPDATED:     August 19, 2025

Copyright (c) 2022-2025 Jericho Crosby (Chalwk)
LICENSE:          MIT License
                  https://github.com/Chalwk/HALO-SCRIPT-PROJECTS/blob/master/LICENSE
=====================================================================================
]]

-----------------
-- CONFIG STARTS
-----------------

local CROUCH_ACTIVATED = false  -- Set to true for crouch-only activation
local COOLDOWN = 0              -- Cooldown in seconds (0 = disabled)

local CFG = {
    ["bloodgulch"] = {
		{ 48.046, -153.087, 21.181, 0.5, 23.112, -59.428, 16.352, 0 },
		{ 43.258, -45.365, 20.901, 0.5, 82.068, -68.505, 18.101, 0 },
		{ 82.459, -73.877, 15.729, 0.5, 67.970, -86.299, 23.393, 0 },
		{ 77.756, -89.082, 22.434, 0.5, 92.456, -111.263, 14.945, 0 },
		{ 101.136, -117.054, 14.962, 0.5, 105.877, -117.677, 15.323, 0 },
		{ 116.826, -120.564, 15.109, 0.5, 124.988, -135.579, 13.575, 0 },
		{ 131.785, -169.872, 15.951, 0.5, 127.812, -184.557, 16.420, 0 },
		{ 120.665, -188.766, 13.752, 0.5, 109.956, -188.522, 14.437, 0 },
		{ 97.476, -188.912, 15.718, 0.5, 53.653, -157.885, 21.753, 0 },
		{ 56.664, -164.837, 22.795, 0.5, 96.744, -186.242, 14.131, 0 },
		{ 111.995, -188.984, 14.651, 0.5, 122.376, -187.829, 13.938, 0 },
		{ 129.211, -183.764, 17.222, 0.5, 130.083, -170.598, 14.916, 0 },
		{ 128.141, -136.294, 14.547, 0.5, 112.550, -127.203, 1.905, 0 },
		{ 118.263, -120.761, 17.192, 0.5, 39.968, -139.983, 2.518, 0 },
		{ 102.131, -117.216, 14.871, 0.5, 100.467, -116.833, 14.929, 0 },
		{ 90.741, -109.854, 14.751, 0.5, 74.335, -89.752, 23.676, 0 },
		{ 68.909, -82.116, 22.843, 0.5, 82.065, -68.507, 18.152, 0 },
		{ 78.907, -64.793, 19.836, 0.5, 33.687, -50.148, 19.162, 0 },
		{ 21.916, -61.007, 16.189, 0.5, 50.409, -155.826, 21.830, 0 },
		{ 14.852, -99.241, 8.995, 0.5, 50.409, -155.826, 21.830, 0 },
		{ 98.559, -158.558, -0.253, 0.5, 63.338, -169.305, 3.702, 0 },
		{ 98.541, -160.190, -0.255, 0.5, 119.995, -183.364, 6.667, 0 },
		{ 92.538, -160.213, -0.215, 0.5, 112.550, -127.203, 1.905, 0 },
		{ 92.550, -158.581, -0.256, 0.5, 46.934, -151.024, 4.496, 0 },
		{ 98.935, -157.626, 0.425, 0.5, 96.431, -121.027, 3.757, 0 },
		{ 74.304, -77.590, 6.552, 0.5, 76.001, -77.936, 11.425, 0 },
		{ 94.351, -97.615, 5.184, 0.5, 92.792, -93.604, 9.501, 0 },
		{ 84.848, -127.267, 0.563, 0.5, 74.335, -89.752, 23.676, 0 },
		{ 63.693, -177.303, 5.606, 0.5, 19.030, -103.428, 19.150, 0 },
		{ 70.535, -62.097, 5.392, 0.5, 122.491, -123.891, 15.646, 0 },
		{ 89.473, -115.480, 17.013, 0.5, 108.005, -109.328, 1.924, 0 },
		{ 120.605, -185.611, 7.626, 0.5, 95.746, -114.248, 16.032, 0 },
		{ 43.125, -78.434, -0.273, 0.5, 15.720, -102.766, 13.465, 0 },
		{ 43.112, -80.069, -0.278, 0.5, 68.123, -92.847, 2.167, 0 },
		{ 37.105, -80.069, -0.255, 0.5, 108.005, -109.328, 1.924, 0 },
		{ 37.080, -78.426, -0.238, 0.5, 79.924, -64.560, 4.669, 0 },
		{ 38.559, -79.209, 0.769, 0.5, 69.833, -88.165, 5.660, 0 },
		{ 43.456, -77.197, 0.633, 0.5, 29.528, -52.746, 3.100, 0 },
    },

    ["dangercanyon"] = {
        { -0.027, 46.850, -8.366, 0.5, -0.468, 55.960, 0.239, 0.1 },
        { -0.066, 44.175, -8.366, 0.5, -0.044, 33.858, 0.266, 0.1 },
        { -0.009, 21.902, 0.256, 0.5, -0.057, 40.466, -7.411, 0.1 },
        { -2.966, -3.470, -4.025, 0.5, -3.613, -3.566, 2.664, 0.1 },
        { 2.863, -3.440, -4.025, 0.5, 3.459, -3.441, 2.664, 0.1 },
        { -0.031, 45.537, -4.508, 0.5, -0.336, 29.039, 5.553, 0.1 },
        { -3.856, 32.264, 4.143, 0.5, -3.824, 47.235, -8.338, 0.1 },
        { 3.678, 32.264, 4.157, 0.5, 4.140, 49.097, -8.322, 0.1 },
        { -14.787, 2.389, -2.489, 0.5, -59.130, 26.030, -11.785, 0.1 },
        { 9.355, 2.369, -2.500, 0.5, 52.993, 6.478, -4.943, 0.1 },
    },

    ["icefields"] = {
        { 24.828, -25.102, 2.544, 0.5, 24.859, -34.435, 3.470, 0.1 },
        { 24.806, -19.166, 2.601, 0.5, 16.201, 2.106, 9.259, 0.1 },
        { -77.864, 89.506, 2.680, 0.5, -77.891, 98.957, 3.470, 0.1 },
        { -77.848, 83.557, 2.659, 0.5, -68.264, 59.707, 9.692, 0.1 },
        { -34.108, 34.317, 2.958, 0.5, -21.950, 39.617, 21.357, 0.1 },
        { -25.563, 49.882, 19.223, 0.5, -29.427, 42.726, 8.922, 0.1 },
        { -15.232, 43.795, 19.415, 0.5, -10.903, 44.825, 2.322, 0.1 },
    },

    ["deathisland"] = {
        { -17.190, -5.370, 10.526, 0.5, -21.057, -8.360, 16.728, 0.1 },
        { -17.190, -5.369, 10.526, 0.5, -21.037, -5.688, 16.728, 0.1 },
        { 20.499, 14.420, 9.144, 0.5, 24.305, 14.455, 15.345, 0.1 },
        { 20.499, 17.584, 9.144, 0.5, 24.320, 14.474, 15.345, 0.1 },
        { -30.694, 39.822, 16.610, 0.5, 5.195, -25.003, 3.357, 0.1 },
        { -26.946, 0.302, 10.252, 0.5, -19.691, -6.975, 22.362, 0.1 },
        { 31.019, 23.003, 8.887, 0.5, 22.315, 16.067, 20.972, 0.1 },
    },

    ["infinity"] = {
        { 0.671, -154.694, 22.335, 0.5, 9.371, -64.067, 7.782, 0.1 },
        { 0.735, -163.273, 13.247, 0.5, -48.368, -89.217, 13.070, 0.1 },
        { -1.923, 46.430, 10.000, 0.5, -52.893, -9.964, 20.929, 0.1 },
        { 16.452, -64.293, 28.450, 0.5, -40.398, -61.993, 35.969, 0.1 },
        { -13.165, -64.288, 28.513, 0.5, 53.598, -53.121, 34.887, 0.1 },
        { 34.220, -63.768, 34.753, 0.5, 18.952, -64.228, 27.970, 0.1 },
        { 56.955, -10.974, 12.124, 0.5, -29.381, -63.086, 11.557, 0.1 },
    },

    ["sidewinder"] = {
        { -33.352, -12.460, -0.853, 0.5, -31.464, 27.740, 0.709, 0.1 },
        { 32.157, -6.941, -2.002, 0.5, 4.054, -13.035, 2.558, 0.1 },
        { -1.848, -44.052, -3.842, 0.5, 6.346, 57.908, -2.838, 0.1 },
    },

    ["timberland"] = {
        { 17.283, -52.649, -14.875, 0.5, 17.537, -60.305, -7.401, 0.1 },
        { 16.006, -52.213, -11.752, 0.5, 16.205, -36.544, -16.994, 0.1 },
        { -16.342, 52.534, -15.254, 0.5, -16.957, 60.568, -7.175, 0.1 },
        { -18.100, 53.626, -11.752, 0.5, -12.974, 37.185, -17.278, 0.1 },
        { 13.433, 50.787, -15.420, 0.5, -35.517, -37.757, -21.356, 0.1 },
        { -31.052, -37.434, -20.255, 0.5, 22.660, 20.760, -15.830, 0.1 },
    },

    ["gephyrophobia"] = {
        { 26.804, -17.049, -8.031, 0.5, 29.839, -72.240, 11.022, 0.1 },
        { 26.795, -127.475, -8.063, 0.5, 23.528, -72.316, 11.022, 0.1 },
        { 26.791, -74.000, -20.316, 0.5, 26.730, -72.341, -10.717, 0.1 },
        { 26.783, -74.000, -20.316, 0.5, 26.917, -72.764, -10.717, 0.1 },
        { -26.678, -84.331, -1.255, 0.5, 26.871, -148.202, -17.734, 0.1 },
        { 71.340, -73.805, -1.062, 0.5, 26.765, 3.648, -17.734, 0.1 },
    },

    ["beavercreek"] = {
        { 30.407, 13.770, 0.392, 0.5, 26.332, 13.755, 1.405, 0.1 },
        { -2.300, 13.707, 0.498, 0.5, 1.870, 13.864, 1.401, 0.1 },
    },

    ["boardingaction"] = {
        { 12.918, 19.959, 4.855, 0.5, 0.844, 20.107, 5.218, 0.1 },
        { 7.192, -19.827, 4.855, 0.5, 19.389, -20.011, 5.218, 0.1 },
        { 1.964, -4.372, 3.437, 0.5, 20.258, -13.257, 17.341, 0.1 },
        { 18.063, 4.373, 3.117, 0.5, -0.412, 13.305, 17.301, 0.1 },
    },

    ["carousel"] = {
        { -0.002, -11.812, 0.738, 0.5, 0.020, -0.933, 1.644, 0.1 },
        { -0.017, 11.810, 0.738, 0.5, -0.001, 0.585, 1.644, 0.1 },
        { 15.710, -2.288, -0.210, 0.5, -9.680, 7.023, 0.730, 0.1 },
        { -15.710, 2.287, -0.218, 0.5, 8.230, -8.459, 0.649, 0.1 },
    },

    ["chillout"] = {
        { 7.870, 8.363, -0.000, 0.5, 12.472, 3.786, 3.535, 0.1 },
        { 1.449, -4.585, 1.566, 0.5, 7.870, 9.153, 4.674, 0.1 },
        { 9.341, -0.615, 0.651, 0.5, -1.972, 12.767, 1.399, 0.1 },
        { 5.358, 11.223, 0.746, 0.5, -1.966, 11.135, 4.168, 0.1 },
        { -8.400, 8.283, -0.000, 0.5, -0.252, -2.638, -0.000, 0.1 },
    },

    ["damnation"] = {
        { -3.650, -9.351, 7.092, 0.5, -0.150, 6.050, 0.000, 0.1 },
        { -7.899, 12.957, 0.250, 0.5, 9.202, 6.050, 3.400, 0.1 },
        { -12.535, -13.625, 4.135, 0.5, -0.100, -8.499, 13.200, 0.1 },
        { 9.612, 1.500, 6.700, 0.5, -1.450, 1.472, -0.200, 0.1 },
    },

    ["hangemhigh"] = {
        { 25.319, -14.279, -7.315, 0.5, 15.917, -7.339, -3.469, 0.1 },
        { 12.710, 7.338, -7.304, 0.5, 16.065, -7.278, -3.469, 0.1 },
        { 35.330, 4.894, -7.328, 0.5, 22.238, -2.894, 7.567, 0.1 },
        { 35.550, 1.881, 1.003, 0.5, 19.685, -2.482, -9.252, 0.1 },
        { 35.550, -8.704, 1.003, 0.5, 19.847, -2.461, -9.252, 0.1 },
        { 6.437, -8.704, 0.918, 0.5, 19.990, -2.396, -9.252, 0.1 },
        { 6.437, 1.881, 0.918, 0.5, 19.848, -2.453, -9.252, 0.1 },
    },

    ["longest"] = {
        { 12.272, -15.732, 0.626, 0.5, 0.165, -14.836, 2.104, 0.1 },
        { -14.028, -13.333, 0.638, 0.5, -2.150, -14.312, 2.104, 0.1 },
        { 11.157, -10.733, 0.038, 0.5, 3.222, -19.832, 2.056, 0.1 },
        { -12.910, -18.333, 0.045, 0.5, 6.422, -10.233, 2.056, 0.1 },
    },

    ["prisoner"] = {
        { 0.886, -0.009, 0.123, 0.5, 0.513, -0.213, 3.192, 0.1 },
        { -9.797, 7.297, -0.335, 0.5, 5.994, -3.638, 3.192, 0.1 },
        { 10.695, 1.005, -0.338, 0.5, -8.578, 2.174, 1.392, 0.1 },
        { -5.633, 7.336, 1.850, 0.3, -5.845, 6.067, 3.192, 0.1 },
    },

    ["putput"] = {
        { -17.625, -20.192, 3.202, 0.5, 17.271, -4.548, 0.102, 0.1 },
        { 32.577, -9.972, 1.540, 0.5, 11.686, -32.480, 1.502, 0.1 },
        { -5.299, -33.925, 1.553, 0.5, 12.888, -19.729, -0.000, 0.1 },
        { 12.885, -21.529, 0.650, 0.5, 13.626, -29.403, 2.828, 0.1 },
        { -5.299, -36.191, 2.954, 0.5, -2.926, -2.280, 2.983, 0.1 },
    },

    ["ratrace"] = {
        { 6.370, -7.038, 0.874, 0.5, 8.939, -27.737, -2.039, 0.1 },
        { 10.368, -7.040, 0.832, 0.5, 23.302, -5.667, -0.567, 0.1 },
        { 23.302, -4.797, -1.465, 0.5, -4.882, -17.237, -0.550, 0.1 },
        { -5.948, -17.237, -1.469, 0.5, -2.531, 1.015, 1.716, 0.1 },
    },

    ["wizard"] = {
        { 5.710, 5.756, -3.862, 0.5, 9.975, 10.035, 0.121, 0.1 },
        { -5.695, -5.776, -3.849, 0.5, -9.982, -9.881, 0.021, 0.1 },
        { -5.782, 5.688, -3.847, 0.5, -9.884, 9.982, 0.027, 0.1 },
        { 5.790, -5.677, -3.865, 0.5, 9.842, -9.991, 0.004, 0.1 },
    }
}

---------------
-- CONFIG ENDS
---------------

api_version = "1.12.0.0"

local map_cfg
local last_teleport = {}

local rprint = rprint
local os_time = os.time
local read_float = read_float
local read_dword = read_dword
local player_alive = player_alive
local read_vector3d = read_vector3d
local write_vector3d = write_vector3d
local player_present = player_present
local get_dynamic_player = get_dynamic_player

function OnScriptLoad()
    register_callback(cb['EVENT_LEAVE'], 'OnQuit')
    register_callback(cb['EVENT_GAME_START'], 'OnStart')
    OnStart()
end

local function precompute_teleports(cfg)
    for _, t in ipairs(cfg) do
        local cx, cy, cz = t[1], t[2], t[3]
        local radius = t[4] or 0.0

        t.cx, t.cy, t.cz = cx, cy, cz
        t.radius = radius
        t.radius_sq = radius * radius

        t.destX, t.destY, t.destZ = t[5], t[6], t[7]
        t.zOff = t[8] or 0

        -- Axis-aligned bounding box for a cheap early reject
        t.minX, t.maxX = cx - radius, cx + radius
        t.minY, t.maxY = cy - radius, cy + radius
        t.minZ, t.maxZ = cz - radius, cz + radius
    end
end

function OnStart()
    if get_var(0, '$gt') == 'n/a' then return end

    local map = get_var(0, '$map')
    local cfg = CFG[map]

    if cfg then

        local tmp = {}
        for i, entry in ipairs(cfg) do tmp[i] = { unpack(entry) } end

        precompute_teleports(tmp)
        map_cfg = tmp

        register_callback(cb['EVENT_TICK'], 'OnTick')
    else
        unregister_callback(cb['EVENT_TICK'])
    end
end

function OnTick()
    for i = 1, 16 do
        if not player_present(i) or not player_alive(i) then goto continue end

        local dyn = get_dynamic_player(i)
        if dyn == 0 then goto continue end

        -- vehicle check
        if read_dword(dyn + 0x11C) == 0xFFFFFFF then goto continue end

        local position = dyn + 0x5C
        local x, y, z = read_vector3d(position)

        if CROUCH_ACTIVATED then
            local crouch_state = read_float(dyn + 0x50C)
            if crouch_state ~= 1 then goto continue end
            z = z + 0.35
        end

        -- cooldown check
        local last = last_teleport[i]
        if last and os_time() < last + COOLDOWN then goto continue end

        -- iterate teleporters:
        for _, t in ipairs(map_cfg) do

            if x >= t.minX and x <= t.maxX
            and y >= t.minY and y <= t.maxY
            and z >= t.minZ and z <= t.maxZ then

                local dx = x - t.cx
                local dy = y - t.cy
                local dz = z - t.cz
                local distSq = dx * dx + dy * dy + dz * dz

                if distSq <= t.radius_sq then
                    local zOff = (CROUCH_ACTIVATED and 0) or t.zOff

                    write_vector3d(position, t.destX, t.destY, t.destZ + zOff)
                    rprint(i, 'WOOSH!')
                    last_teleport[i] = os_time()
                    break
                end
            end
        end

        ::continue::
    end
end

function OnQuit(id)
    last_teleport[id] = nil
end

function OnScriptUnload() end