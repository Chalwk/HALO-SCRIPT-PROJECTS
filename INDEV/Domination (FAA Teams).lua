--[[
--=====================================================================================================--
Script Name: Domination, for SAPP (PC & CE)
Description: N/A

Copyright (c) 2016-2018, Jericho Crosby <jericho.crosby227@gmail.com>
* Notice: You can use this document subject to the following conditions:
https://github.com/Chalwk77/Halo-Scripts-Phasor-V2-/blob/master/LICENSE

* Written by Jericho Crosby (Chalwk)
--=====================================================================================================--
]]--

api_version = "1.12.0.0"

-- Configuration [starts]

-- Game Start Countdown Timer
delay = 2 -- In Seconds


-- Configuration [ends] << ----------

-- tables --
spawns = { }
players = { }
team = { }
first_join = {}

-- Booleans
gamestarted = nil
red_count = 0
blue_count = 0

function OnScriptLoad()
    register_callback(cb['EVENT_TICK'], "OnTick")

    register_callback(cb["EVENT_GAME_START"], "OnNewGame")
    register_callback(cb["EVENT_GAME_END"], "OnGameEnd")

    register_callback(cb["EVENT_JOIN"], "OnPlayerJoin")
    register_callback(cb["EVENT_COMMAND"], "DebugCommand")
    register_callback(cb['EVENT_PRESPAWN'], 'OnPlayerPrespawn')
end

function OnNewGame()
    startTimer()
end

function OnGameEnd()
    stopTimer()
    gamestarted = false
end

function OnTick()
    if (init_countdown == true) then
        countdown = countdown + 0.030

        local seconds = secondsToTime(countdown)
        timeRemaining = delay - math.floor(seconds)

        cprint("Game will begin in " .. timeRemaining .. " seconds", 4 + 8)

        if (timeRemaining <= 0) then
            cprint("The game has begun!", 2 + 8)
            sortPlayers()
            stopTimer()
            gamestarted = true
        end
    end
end

function secondsToTime(seconds)
    seconds = seconds % 60
    return seconds
end

function startTimer()
    countdown = 0
    init_countdown = true
end

function stopTimer()
    countdown = 0
    init_countdown = false
    if timeRemaining ~= nil then
        cprint("The countdown was stopped at " .. timeRemaining .. " seconds")
    end
end

-- Sorts players into teams of two
function sortPlayers()
    if (isTeamPlay() == true) then
        -- Rely on SAPP's auto balance
    else
        -- Split players into custom teams of two | (ffa)
        local t = {}
        local total
        for i = 1, 16 do
            if player_present(i) then
                total = tonumber(i)
                table.insert(t, total)
            end
        end

        -- Blue Team | first half
        for i = 1, #t / 2 do
            if player_present(i) then
                players[get_var(i, "$name")].team = "blue"
                blue_count = red_count + 1
                break
            end
        end

        -- Red Team | second half
        for i = #t / 2, #t do
            if player_present(i) then
                players[get_var(i, "$name")].team = "red"
                red_count = red_count + 1
                break
            end
        end
    end
end

function OnPlayerJoin(PlayerIndex)
    first_join[PlayerIndex] = true
    if not isTeamPlay() then
        players[get_var(PlayerIndex, "$name")] = { }
        players[get_var(PlayerIndex, "$name")].team = nil
        if (gamestarted == true) then
        
                -- Red team has less players (join this team)
            if (red_count < blue_count) then
                players[get_var(PlayerIndex, "$name")].team = "red"

                -- Blue team has less players (join this team)
            elseif (blue_count < red_count) then
                players[get_var(PlayerIndex, "$name")].team = "blue"

                -- Teams are even
            elseif (blue_count == red_count) then
                players[get_var(PlayerIndex, "$name")].team = pickRandomTeam()
            end
        end
    end
end

function pickRandomTeam()
    math.randomseed(os.time())
    math.random();
    local num = math.random(1, 2)
    local team
    if (num == 1) then
        team = "red"
    else
        team = "blue"
    end
    return team
end

function pickRandomCoord(Min, Max)
    math.randomseed(os.time())
    math.random();
    local num = math.random(Min, Max)
    if (num) then
        return num
    end
end

function isTeamPlay()
    if get_var(0, "$ffa") == "0" then
        return true
    else
        return false
    end
end

function OnPlayerPrespawn(PlayerIndex)
    local team = players[get_var(PlayerIndex, "$name")].team
    spawnPlayer(PlayerIndex, team)
end

function spawnPlayer(PlayerIndex, Team)
    local player = get_dynamic_player(PlayerIndex)
    if (player ~= 0) then
        local map = get_var(0, "$map")
        local x,y,z
        if (Team == "blue") then
            local id = chooseRandomSpawn("blue", map)
            cprint(id)
            x = spawns[map].blue[id][1]
            y = spawns[map].blue[id][2]
            z = spawns[map].blue[id][3]
        elseif (Team == "red") then
            local id = chooseRandomSpawn("red", map)
            cprint(id)
            x = spawns[map].red[id][1]
            y = spawns[map].red[id][2]
            z = spawns[map].red[id][3]
        end
        write_vector3d(player + 0x5C, x, y, z + 0.3)
    end
end

function chooseRandomSpawn(team, map)
    local index
    if (team =="blue") then
        index = pickRandomCoord(1, #spawns[map].blue)
    elseif (team =="red") then
        index = pickRandomCoord(1, #spawns[map].red)
    end
    return index
end

function DebugCommand(PlayerIndex, Command, Environment, Password)
    if (string.lower(Command) == "sort") then
        sortPlayers()
        rprint(PlayerIndex, "Sorting Players...")
        return false
    end
end

spawns["bloodgulch"] = {
    red = {
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 }
    },
    blue = {
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 }
    }
}
spawns["deathisland"] = {
    red = {
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 }
    },
    blue = {
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 }
    }
}
spawns["icefields"] = {
    red = {
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 }
    },
    blue = {
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 }
    }
}
spawns["infinity"] = {
    red = {
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 }
    },
    blue = {
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 }
    }
}
spawns["sidewinder"] = {
    red = {
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 }
    },
    blue = {
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 }
    }
}
spawns["timberland"] = {
    red = {
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 }
    },
    blue = {
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 }
    }
}
spawns["dangercanyon"] = {
    red = {
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 }
    },
    blue = {
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 }
    }
}
spawns["beavercreek"] = {
    red = {
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 }
    },
    blue = {
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 }
    }
}
spawns["boardingaction"] = {
    red = {
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 }
    },
    blue = {
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 }
    }
}
spawns["carousel"] = {
    red = {
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 }
    },
    blue = {
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 }
    }
}
spawns["chillout"] = {
    red = {
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 }
    },
    blue = {
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 }
    }
}
spawns["damnation"] = {
    red = {
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 }
    },
    blue = {
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 }
    }
}
spawns["gephyrophobia"] = {
    red = {
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 }
    },
    blue = {
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 }
    }
}
spawns["hangemhigh"] = {
    red = {
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 }
    },
    blue = {
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 }
    }
}
spawns["longest"] = {
    red = {
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 }
    },
    blue = {
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 }
    }
}
spawns["prisoner"] = {
    red = {
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 }
    },
    blue = {
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 }
    }
}
spawns["putput"] = {
    red = {
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 }
    },
    blue = {
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 }
    }
}
spawns["ratrace"] = {
    red = {
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 }
    },
    blue = {
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 }
    }
}
spawns["wizard"] = {
    red = {
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 },
        { 95.687797546387, -159.44900512695, -0.10000000149012 }
    },
    blue = {
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 },
        { 40.240600585938, -79.123199462891, -0.10000000149012 }
    }
}
